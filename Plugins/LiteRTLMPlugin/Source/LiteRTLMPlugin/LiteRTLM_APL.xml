<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android">
	<baseBuildGradleAdditions>
		<insert>
			allprojects {
			repositories {
			google()
			mavenCentral()
			}
			}
		</insert>
	</baseBuildGradleAdditions>

	<buildGradleAdditions>
		<insert>
			dependencies {
			implementation 'com.google.ai.edge.litertlm:litertlm-android:latest.release'
			implementation 'org.jetbrains.kotlin:kotlin-stdlib:1.9.20'
			implementation 'org.jetbrains:annotations:24.0.0'
			implementation 'com.google.guava:guava:32.1.3-android'
			}
		</insert>
	</buildGradleAdditions>

	<androidManifestUpdates>
		<addElements tag="application">
			<uses-native-library android:name="libvndksupport.so" android:required="false"/>
			<uses-native-library android:name="libOpenCL.so" android:required="false"/>
		</addElements>
	</androidManifestUpdates>

	<gameActivityImportAdditions>
		<insert>
			import com.google.ai.edge.litertlm.Content;
			import com.google.ai.edge.litertlm.Message;
		</insert>
	</gameActivityImportAdditions>

	<gameActivityClassAdditions>
		<insert>
			private com.google.ai.edge.litertlm.Engine lmEngine;
			private com.google.ai.edge.litertlm.Conversation lmConversation;
			private com.google.ai.edge.litertlm.Message lmMessage;



			public void AndroidThunkJava_InitWithFunctions(String modelPath) {
			try {
			com.google.ai.edge.litertlm.Backend gpu = com.google.ai.edge.litertlm.Backend.GPU;
			com.google.ai.edge.litertlm.Backend cpu = com.google.ai.edge.litertlm.Backend.CPU;

			com.google.ai.edge.litertlm.EngineConfig config = new com.google.ai.edge.litertlm.EngineConfig(
			modelPath,              // 1. String: Model Path
			cpu,                    // 2. Backend: Base Backend
			null,                    // 3. Backend: Prefill Backend
			null,                    // 4. Backend: Decode Backend
			512,                   // 5. Integer: Max Context Length
			getCacheDir().getPath() // 6. String: Cache Directory Path
			);

			lmEngine = new com.google.ai.edge.litertlm.Engine(config);
			lmEngine.initialize();

			com.google.ai.edge.litertlm.SamplerConfig sampler = new com.google.ai.edge.litertlm.SamplerConfig(40, 0.95, 0.1, 128);
			String systemPrompt = "You are a model that can do function calling. " +
			"Tools: [go_forward(), go_backward(), go_left(), go_right()]";

			com.google.ai.edge.litertlm.ConversationConfig convConfig = new com.google.ai.edge.litertlm.ConversationConfig(
			com.google.ai.edge.litertlm.Message.Companion.of(systemPrompt),
			java.util.Collections.emptyList(),
			sampler);
			lmConversation = lmEngine.createConversation(convConfig);

			android.util.Log.d("LiteRT-LM", "Engine and Conversation Initialized");

			} catch (Exception e) {
			android.util.Log.e("LiteRT-LM", "Initialization failed: " + e.getMessage());
			}
			}

			public String AndroidThunkJava_GenerateResponse(String prompt) {
			if (lmEngine == null || lmConversation == null) {
			return "Error: Engine not initialized";
			}

			try {


			String aiResult = lmConversation.sendMessage(lmMessage.Companion.of(prompt)).toString();

			return aiResult;
			} catch (Exception e) {
			return "Error during generation: " + e.getMessage();
			}
			}


			public void AndroidThunkJava_SubmitFunctionResult(String functionName, String resultJson) {
			String toolMessage = "response:" + functionName + resultJson;
			lmConversation.sendMessage(com.google.ai.edge.litertlm.Message.Companion.of(toolMessage));
			}

			public void AndroidThunkJava_ResetConversation() {
			lmConversation.close();
			com.google.ai.edge.litertlm.SamplerConfig sampler = new com.google.ai.edge.litertlm.SamplerConfig(40, 0.95, 0.1, 128);
			String systemPrompt = "You are a model that can do function calling. " +
			"Tools: [go_forward(), go_backward(), go_left(), go_right()]";

			com.google.ai.edge.litertlm.ConversationConfig convConfig = new com.google.ai.edge.litertlm.ConversationConfig(
			com.google.ai.edge.litertlm.Message.Companion.of(systemPrompt),
			java.util.Collections.emptyList(),
			sampler);
			lmConversation = lmEngine.createConversation(convConfig);
			}

			public void AndroidThunkJava_CloseConnection() {
			if (lmEngine != null || lmConversation != null) {
			lmEngine.close();
			lmConversation.close();
			}

			}


			private String copyAssetToInternal(String fileName) {
			java.io.File file = new java.io.File(getFilesDir(), fileName);
			if (!file.exists()) {
			try (java.io.InputStream is = getAssets().open(fileName);
			java.io.OutputStream os = new java.io.FileOutputStream(file)) {
			byte[] buffer = new byte[1024];
			int length;
			while ((length = is.read(buffer)) > 0) {
			os.write(buffer, 0, length);
			}
			android.util.Log.d("LiteRT-LM", "Model copied to: " + file.getAbsolutePath());
			} catch (java.io.IOException e) {
			android.util.Log.e("LiteRT-LM", "Failed to copy asset: " + e.getMessage());
			return null;
			}
			}
			return file.getAbsolutePath();
			}

			public void AndroidThunkJava_InitWithAssetName(String assetName) {
			String internalPath = copyAssetToInternal(assetName);
			if (internalPath != null) {
			AndroidThunkJava_InitWithFunctions(internalPath);
			}
			}

		</insert>
	</gameActivityClassAdditions>
</root>